version: "3.9"

services:
  db:
    image: postgres:12
    restart: always
    ports:
      - '5433:5432'
    environment:
      POSTGRES_DB: "${DB_NAME}"
      POSTGRES_USER: "${DB_USER}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - db:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/create_tables.sql
  redis:
    image: redis:6.2.6
    restart: always
    ports:
      - "6364:6379"
  rabbitmq:
    image: rabbitmq:3.9
    restart: always
    ports:
      - "5672:5672"
  control_panel:
    build: services/control_panel
    restart: always
    ports:
      - '80:80'
    environment:
      NODE_ENV: production
    volumes:
      - '.:/app'
  worker:
    build:
      context: '.'
    restart: always
    command: poetry run celery --app services.worker.app worker --loglevel INFO
    depends_on:
      - redis
      - rabbitmq
    environment:
      ASSISTANT_GRPC_ADDR: "assistant:50051"
      BROKER_URL: "redis://redis"
      BACKEND_URL: "redis://redis"
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ".:/app"
      - youtube_videos:/tmp/youtube
  control_panel_api:
    build:
      context: '.'
    restart: always
    ports:
      - '8000'
    depends_on:
      - db
    command: poetry run uvicorn services.control_panel_api.main:app --host 0.0.0.0 --port 8000
    environment:
      DB_NAME: "${DB_NAME}"
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_HOST: db
    volumes:
      - '.:/app'
  assistant_manager:
    build:
      context: '.'
    restart: always
    command: poetry run python -m services.assistant_manager.main
    depends_on:
      - redis
    environment:
      TELEGRAM_API_TOKEN: "${TELEGRAM_API_TOKEN}"
      MY_TELEGRAM_ID: "${MY_TELEGRAM_ID}"
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ".:/app"
  assistant:
    build:
      context: '.'
    restart: always
    command: poetry run python -m services.assistant.main
    depends_on:
      - redis
      - worker
    ports:
      - "50051:50051"
    environment:
      ASSISTANT_GRPC_ADDR: "assistant:50051"
      AIOTDLIB_API_ID: "${AIOTDLIB_API_ID}"
      AIOTDLIB_API_HASH: "${AIOTDLIB_API_HASH}"
      PHONE_NUMBER: "${PHONE_NUMBER}"
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ".:/app"
      - youtube_videos:/tmp/youtube

volumes:
  db:
    driver: local
  youtube_videos: